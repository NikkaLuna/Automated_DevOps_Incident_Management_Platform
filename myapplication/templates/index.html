<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incident Management System</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <header>
        <div class="logo">IncidentManage</div>
        <nav>
            <ul>
                <li><a href="#">Dashboard</a></li>
                <li><a href="#">Incidents</a></li>
                <li><a href="#">Analytics</a></li>
                <li><a href="#">Settings</a></li>
                <li><a href="#">Support</a></li>
            </ul>
        </nav>
        <div class="user-profile">
            <img src="{% static 'img/user.png' %}" alt="User Profile">
            <div class="dropdown">
                <ul>
                    <li><a href="#">Profile Settings</a></li>
                    <li><a href="#">Notifications</a></li>
                    <li><a href="#">Logout</a></li>
                </ul>
            </div>
        </div>
    </header>
    <aside>
        <div class="sidebar">
            <input type="text" placeholder="Search...">
            <ul>
                <li><a href="#">Active Incidents</a></li>
                <li><a href="#">Resolved Incidents</a></li>
                <li><a href="#">Escalations</a></li>
                <li><a href="#">Notifications</a></li>
                <li><a href="#">Documentation</a></li>
            </ul>
        </div>
    </aside>
    <main>
        <section class="widgets">
            <div class="widget">Open Incidents</div>
            <div class="widget">Resolved Incidents</div>
            <div class="widget">Escalations</div>
            <div class="widget">Notifications</div>
        </section>
        <section class="management-panels">
            <div class="panel">
                <h2>Incident Management</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Incident ID</th>
                            <th>Title</th>
                            <th>Status</th>
                            <th>Severity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="incidentTableBody">
                        <!-- Dynamic content here -->
                    </tbody>
                </table>
                <button id="createIncidentButton">Create New Incident</button>
            </div>
            <div class="panel">
                <h2>Incident Resolution Workflows</h2>
                <!-- Create and Edit Forms -->
                <div class="forms">
                    <form id="createIncidentForm">
                        <label for="title">Title:</label>
                        <input type="text" id="title" name="title">
                        <label for="description">Description:</label>
                        <textarea id="description" name="description"></textarea>
                        <label for="severity">Severity:</label>
                        <select id="severity" name="severity">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                        <button type="submit">Create</button>
                    </form>
                    <form id="editIncidentForm" style="display:none;">
                        <label for="title">Title:</label>
                        <input type="text" id="editTitle" name="title">
                        <label for="description">Description:</label>
                        <textarea id="editDescription" name="description"></textarea>
                        <label for="severity">Severity:</label>
                        <select id="editSeverity" name="severity">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                        <button type="submit">Update</button>
                    </form>
                </div>
                <div id="incidentCards">
                    <!-- Cards will be populated dynamically -->
                </div>
            </div>
        </section>
        <section class="analytics-monitoring">
            <div class="analytics">
                <h2>Incident Analytics</h2>
                <!-- Graphs and data visualizations -->
            </div>
            <div class="alerts">
                <h2>Escalation Alerts</h2>
                <!-- Alerts list -->
            </div>
            <div class="cost-analysis">
                <h2>Incident Cost Analysis</h2>
                <!-- Cost breakdown charts -->
            </div>
        </section>
        <section class="support">
            <h2>Support and Documentation</h2>
            <button>Live Chat</button>
            <!-- Help center content -->
        </section>
    </main>
    <script src="{% static 'js/script.js' %}"></script>
    <script type="text/javascript">
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        document.getElementById('createIncidentForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            fetch('/create-incident/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData
            }).then(response => response.json())
            .then(data => {
                // Update the incident list dynamically
                updateIncidentList(data);
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchIncidents();
        });

        function fetchIncidents() {
            fetch('http://localhost:8000/api/incidents/')
                .then(response => response.json())
                .then(data => {
                    updateIncidentList(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    const errorMessage = document.createElement('p');
                    errorMessage.textContent = 'Failed to load data.';
                    document.getElementById('incidentTableBody').appendChild(errorMessage);
                });
        }

        function updateIncidentList(data) {
            const incidentTableBody = document.getElementById('incidentTableBody');
            const incidentCards = document.getElementById('incidentCards');
            incidentTableBody.innerHTML = '';
            incidentCards.innerHTML = '';
            data.forEach(incident => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${incident.id}</td>
                    <td>${incident.title}</td>
                    <td>${incident.status}</td>
                    <td>${incident.severity}</td>
                    <td><button onclick="editIncident(${incident.id})">Edit</button></td>
                `;
                incidentTableBody.appendChild(row);

                const card = document.createElement('div');
                card.className = 'incident-card';
                card.innerHTML = `<h3>${incident.title}</h3><p>${incident.description}</p><p>${incident.severity}</p>`;
                incidentCards.appendChild(card);
            });
        }

        function editIncident(id) {
            // Fetch the incident data and populate the edit form
            fetch(`http://localhost:8000/api/incidents/${id}/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('editTitle').value = data.title;
                    document.getElementById('editDescription').value = data.description;
                    document.getElementById('editSeverity').value = data.severity;
                    document.getElementById('editIncidentForm').style.display = 'block';
                    document.getElementById('createIncidentForm').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error fetching incident data:', error);
                });
        }
    </script>
</body>
</html>
